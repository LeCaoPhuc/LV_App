"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var common = require("./image-cache-it.common");
var fs = require("file-system");
var utils = require("utils/utils");
var imageSrc = require("image-source");
global.moduleMerge(common, exports);
var ImageCacheIt = (function (_super) {
    __extends(ImageCacheIt, _super);
    function ImageCacheIt() {
        return _super.call(this) || this;
    }
    Object.defineProperty(ImageCacheIt.prototype, "android", {
        get: function () {
            return this.nativeView;
        },
        enumerable: true,
        configurable: true
    });
    ImageCacheIt.prototype.createNativeView = function () {
        this.picasso = com.squareup.picasso.Picasso.with(this._context);
        return new android.widget.ImageView(this._context);
    };
    ImageCacheIt.prototype.initNativeView = function () {
        this.builder = this.picasso.load(this.getImage(this.imageUri));
        if (this.placeHolder) {
            this.builder.placeholder(imageSrc.fromFileOrResource(this.placeHolder).android);
        }
        if (this.errorHolder) {
            this.builder.error(imageSrc.fromFileOrResource(this.errorHolder).android);
        }
        if (this.resize && this.resize !== undefined && this.resize.split(' ').length > 1) {
            this.builder.resize(parseInt(this.resize.split(' ')[0]), parseInt(this.resize.split(' ')[1]));
        }
        else if (this.override && this.override !== undefined && this.override.split(' ').length > 1) {
            this.builder.resize(parseInt(this.override.split(' ')[0]), parseInt(this.override.split(' ')[1]));
        }
        if (this.centerCrop) {
            this.builder.centerCrop();
        }
        this.builder.into(this.nativeView);
    };
    ImageCacheIt.prototype[common.imageUriProperty.getDefault] = function () {
        return undefined;
    };
    ImageCacheIt.prototype[common.imageUriProperty.setNative] = function (src) {
        if (!this.builder) {
            return;
        }
        this.builder = this.picasso.load(this.getImage(this.imageUri));
        this.builder.into(this.nativeView);
    };
    ImageCacheIt.prototype[common.resizeProperty.setNative] = function (resize) {
        if (!this.builder) {
            return;
        }
        this.resize = resize;
        this.initNativeView();
    };
    ImageCacheIt.prototype[common.overrideProperty.setNative] = function (override) {
        if (!this.builder) {
            return;
        }
        if (override && override !== undefined && override.split(' ').length > 1) {
            this.builder.resize(parseInt(override.split(' ')[0]), parseInt(override.split(' ')[1]));
        }
    };
    ImageCacheIt.prototype.getImage = function (src) {
        var nativeImage;
        if (src.substr(0, 1) === '/') {
            nativeImage = new java.io.File(nativeImage);
        }
        else if (src.startsWith("~/")) {
            nativeImage = new java.io.File(fs.path.join(fs.knownFolders.currentApp().path, src.replace("~/", "")));
        }
        else if (src.startsWith("https://") || src.startsWith("http://")) {
            nativeImage = src;
        }
        else if (src.startsWith('res://')) {
            nativeImage = utils.ad.resources.getDrawableId(src.replace('res://', ''));
        }
        return nativeImage;
    };
    ImageCacheIt.prototype[common.stretchProperty.getDefault] = function () {
        return "aspectFit";
    };
    ImageCacheIt.prototype[common.stretchProperty.setNative] = function (value) {
        switch (value) {
            case 'aspectFit':
                this.nativeView.setScaleType(android.widget.ImageView.ScaleType.FIT_CENTER);
                break;
            case 'aspectFill':
                this.nativeView.setScaleType(android.widget.ImageView.ScaleType.CENTER_CROP);
                break;
            case 'fill':
                this.nativeView.setScaleType(android.widget.ImageView.ScaleType.FIT_XY);
                break;
            case 'none':
            default:
                this.nativeView.setScaleType(android.widget.ImageView.ScaleType.MATRIX);
                break;
        }
    };
    ImageCacheIt.prototype.clearItem = function () {
        // this.builder.
    };
    return ImageCacheIt;
}(common.ImageCacheIt));
exports.ImageCacheIt = ImageCacheIt;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY2FjaGUtaXQuYW5kcm9pZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImltYWdlLWNhY2hlLWl0LmFuZHJvaWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxnREFBa0Q7QUFFbEQsZ0NBQW1DO0FBQ25DLG1DQUFzQztBQUV0Qyx1Q0FBMEM7QUFFMUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFFcEM7SUFBa0MsZ0NBQW1CO0lBR2pEO2VBQ0ksaUJBQU87SUFDWCxDQUFDO0lBRUQsc0JBQUksaUNBQU87YUFBWDtZQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzNCLENBQUM7OztPQUFBO0lBQ00sdUNBQWdCLEdBQXZCO1FBQ0ksSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRSxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUNNLHFDQUFjLEdBQXJCO1FBQ0ksSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBRS9ELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEYsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUks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Q0FBQztJQUVNLGdDQUFTLEdBQWhCO1FBQ0ksZ0JBQWdCO0lBQ3BCLENBQUM7SUFDTCxtQkFBQztBQUFELENBQUMsQUEvRkQsQ0FBa0MsTUFBTSxDQUFDLFlBQVksR0ErRnBEO0FBL0ZZLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY29tbW9uIGZyb20gJy4vaW1hZ2UtY2FjaGUtaXQuY29tbW9uJztcclxuaW1wb3J0IGFwcCA9IHJlcXVpcmUoXCJhcHBsaWNhdGlvblwiKTtcclxuaW1wb3J0IGZzID0gcmVxdWlyZShcImZpbGUtc3lzdGVtXCIpO1xyXG5pbXBvcnQgdXRpbHMgPSByZXF1aXJlKFwidXRpbHMvdXRpbHNcIik7XHJcbmltcG9ydCB0eXBlcyA9IHJlcXVpcmUoXCJ1dGlscy90eXBlc1wiKTtcclxuaW1wb3J0IGltYWdlU3JjID0gcmVxdWlyZShcImltYWdlLXNvdXJjZVwiKTtcclxuaW1wb3J0IHsgVmlldyB9IGZyb20gJ3Rucy1jb3JlLW1vZHVsZXMvdWkvY29yZS92aWV3JztcclxuZ2xvYmFsLm1vZHVsZU1lcmdlKGNvbW1vbiwgZXhwb3J0cyk7XHJcblxyXG5leHBvcnQgY2xhc3MgSW1hZ2VDYWNoZUl0IGV4dGVuZHMgY29tbW9uLkltYWdlQ2FjaGVJdCB7XHJcbiAgICBwaWNhc3NvOiBjb20uc3F1YXJldXAucGljYXNzby5QaWNhc3NvO1xyXG4gICAgcHJpdmF0ZSBidWlsZGVyOiBjb20uc3F1YXJldXAucGljYXNzby5SZXF1ZXN0Q3JlYXRvcjtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGFuZHJvaWQoKTogYW5kcm9pZC53aWRnZXQuSW1hZ2VWaWV3IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5uYXRpdmVWaWV3O1xyXG4gICAgfVxyXG4gICAgcHVibGljIGNyZWF0ZU5hdGl2ZVZpZXcoKSB7XHJcbiAgICAgICAgdGhpcy5waWNhc3NvID0gY29tLnNxdWFyZXVwLnBpY2Fzc28uUGljYXNzby53aXRoKHRoaXMuX2NvbnRleHQpO1xyXG4gICAgICAgIHJldHVybiBuZXcgYW5kcm9pZC53aWRnZXQuSW1hZ2VWaWV3KHRoaXMuX2NvbnRleHQpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGluaXROYXRpdmVWaWV3KCkge1xyXG4gICAgICAgIHRoaXMuYnVpbGRlciA9IHRoaXMucGljYXNzby5sb2FkKHRoaXMuZ2V0SW1hZ2UodGhpcy5pbWFnZVVyaSkpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5wbGFjZUhvbGRlcikge1xyXG4gICAgICAgICAgICB0aGlzLmJ1aWxkZXIucGxhY2Vob2xkZXIoaW1hZ2VTcmMuZnJvbUZpbGVPclJlc291cmNlKHRoaXMucGxhY2VIb2xkZXIpLmFuZHJvaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5lcnJvckhvbGRlcikge1xyXG4gICAgICAgICAgICB0aGlzLmJ1aWxkZXIuZXJyb3IoaW1hZ2VTcmMuZnJvbUZpbGVPclJlc291cmNlKHRoaXMuZXJyb3JIb2xkZXIpLmFuZHJvaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5yZXNpemUgJiYgdGhpcy5yZXNpemUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLnJlc2l6ZS5zcGxpdCgnICcpLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgdGhpcy5idWlsZGVyLnJlc2l6ZShwYXJzZUludCh0aGlzLnJlc2l6ZS5zcGxpdCgnICcpWzBdKSwgcGFyc2VJbnQodGhpcy5yZXNpemUuc3BsaXQoJyAnKVsxXSkpXHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLm92ZXJyaWRlICYmIHRoaXMub3ZlcnJpZGUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLm92ZXJyaWRlLnNwbGl0KCcgJykubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICB0aGlzLmJ1aWxkZXIucmVzaXplKHBhcnNlSW50KHRoaXMub3ZlcnJpZGUuc3BsaXQoJyAnKVswXSksIHBhcnNlSW50KHRoaXMub3ZlcnJpZGUuc3BsaXQoJyAnKVsxXSkpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmNlbnRlckNyb3ApIHtcclxuICAgICAgICAgICAgdGhpcy5idWlsZGVyLmNlbnRlckNyb3AoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5idWlsZGVyLmludG8odGhpcy5uYXRpdmVWaWV3KTtcclxuICAgIH1cclxuICAgIFtjb21tb24uaW1hZ2VVcmlQcm9wZXJ0eS5nZXREZWZhdWx0XSgpOiBhbnkge1xyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICBbY29tbW9uLmltYWdlVXJpUHJvcGVydHkuc2V0TmF0aXZlXShzcmM6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5idWlsZGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5idWlsZGVyID0gdGhpcy5waWNhc3NvLmxvYWQodGhpcy5nZXRJbWFnZSh0aGlzLmltYWdlVXJpKSk7XHJcbiAgICAgICAgdGhpcy5idWlsZGVyLmludG8odGhpcy5uYXRpdmVWaWV3KTtcclxuICAgIH1cclxuICAgIFtjb21tb24ucmVzaXplUHJvcGVydHkuc2V0TmF0aXZlXShyZXNpemU6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5idWlsZGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5yZXNpemUgPSByZXNpemU7XHJcbiAgICAgICAgdGhpcy5pbml0TmF0aXZlVmlldygpO1xyXG4gICAgfVxyXG4gICAgW2NvbW1vbi5vdmVycmlkZVByb3BlcnR5LnNldE5hdGl2ZV0ob3ZlcnJpZGU6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5idWlsZGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG92ZXJyaWRlICYmIG92ZXJyaWRlICE9PSB1bmRlZmluZWQgJiYgb3ZlcnJpZGUuc3BsaXQoJyAnKS5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYnVpbGRlci5yZXNpemUocGFyc2VJbnQob3ZlcnJpZGUuc3BsaXQoJyAnKVswXSksIHBhcnNlSW50KG92ZXJyaWRlLnNwbGl0KCcgJylbMV0pKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgZ2V0SW1hZ2Uoc3JjOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBuYXRpdmVJbWFnZTtcclxuICAgICAgICBpZiAoc3JjLnN1YnN0cigwLCAxKSA9PT0gJy8nKSB7XHJcbiAgICAgICAgICAgIG5hdGl2ZUltYWdlID0gbmV3IGphdmEuaW8uRmlsZShuYXRpdmVJbWFnZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzcmMuc3RhcnRzV2l0aChcIn4vXCIpKSB7XHJcbiAgICAgICAgICAgIG5hdGl2ZUltYWdlID0gbmV3IGphdmEuaW8uRmlsZShmcy5wYXRoLmpvaW4oZnMua25vd25Gb2xkZXJzLmN1cnJlbnRBcHAoKS5wYXRoLCBzcmMucmVwbGFjZShcIn4vXCIsIFwiXCIpKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzcmMuc3RhcnRzV2l0aChcImh0dHBzOi8vXCIpIHx8IHNyYy5zdGFydHNXaXRoKFwiaHR0cDovL1wiKSkge1xyXG4gICAgICAgICAgICBuYXRpdmVJbWFnZSA9IHNyYztcclxuICAgICAgICB9IGVsc2UgaWYgKHNyYy5zdGFydHNXaXRoKCdyZXM6Ly8nKSkge1xyXG4gICAgICAgICAgICBuYXRpdmVJbWFnZSA9IHV0aWxzLmFkLnJlc291cmNlcy5nZXREcmF3YWJsZUlkKHNyYy5yZXBsYWNlKCdyZXM6Ly8nLCAnJykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmF0aXZlSW1hZ2U7XHJcbiAgICB9XHJcbiAgICBbY29tbW9uLnN0cmV0Y2hQcm9wZXJ0eS5nZXREZWZhdWx0XSgpOiBcImFzcGVjdEZpdFwiIHtcclxuICAgICAgICByZXR1cm4gXCJhc3BlY3RGaXRcIjtcclxuICAgIH1cclxuICAgIFtjb21tb24uc3RyZXRjaFByb3BlcnR5LnNldE5hdGl2ZV0odmFsdWU6IFwibm9uZVwiIHwgXCJhc3BlY3RGaWxsXCIgfCBcImFzcGVjdEZpdFwiIHwgXCJmaWxsXCIpIHtcclxuICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ2FzcGVjdEZpdCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5hdGl2ZVZpZXcuc2V0U2NhbGVUeXBlKGFuZHJvaWQud2lkZ2V0LkltYWdlVmlldy5TY2FsZVR5cGUuRklUX0NFTlRFUik7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnYXNwZWN0RmlsbCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5hdGl2ZVZpZXcuc2V0U2NhbGVUeXBlKGFuZHJvaWQud2lkZ2V0LkltYWdlVmlldy5TY2FsZVR5cGUuQ0VOVEVSX0NST1ApO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2ZpbGwnOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5uYXRpdmVWaWV3LnNldFNjYWxlVHlwZShhbmRyb2lkLndpZGdldC5JbWFnZVZpZXcuU2NhbGVUeXBlLkZJVF9YWSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbm9uZSc6XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5hdGl2ZVZpZXcuc2V0U2NhbGVUeXBlKGFuZHJvaWQud2lkZ2V0LkltYWdlVmlldy5TY2FsZVR5cGUuTUFUUklYKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xlYXJJdGVtKCkge1xyXG4gICAgICAgIC8vIHRoaXMuYnVpbGRlci5cclxuICAgIH1cclxufSJdfQ==